## π”’ Javaμ—μ„μ λ™μ‹μ„± μ μ–΄ λ°©μ‹ λ° μ μ© λΉ„κµ

μ΄ ν”„λ΅μ νΈμ—μ„λ” λ‹¨μΌ μ„λ²„ ν™κ²½μ—μ„ **μ‚¬μ©μ ν¬μΈνΈ μ¶©μ „/μ‚¬μ© μ‹μ λ™μ‹μ„± λ¬Έμ **λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄  
**Javaμ λ™μ‹μ„± μ μ–΄ λ°©μ‹**μ„ ν•™μµν•κ³  μ μ©ν–μµλ‹λ‹¤.

---

### β— λ™μ‹μ„± λ¬Έμ λ” μ–΄λ–»κ² λ°μƒν• κΉ?
#### κ³µμ  μμ›μ— λ€ν•΄ λ¶„λ¦¬λ μ—°μ‚°μ„ μν–‰ν•λ” κ³Όμ •μ—μ„ λ°μƒ

#### β… λ™μ‹μ„± μ΄μ μμ‹

- λ™μΌ μ μ €μ—κ² λ™μ‹μ— ν¬μΈνΈ μ¶©μ „/μ‚¬μ© μ”μ²­μ΄ λ“¤μ–΄μ¬ κ²½μ°, **λ μ΄μ¤ μ»¨λ””μ…(Race Condition)** λ°μƒ κ°€λ¥  
  β†’ μλ»λ ν¬μΈνΈ ν•©μ‚°, μμ ν¬μΈνΈ λ“± **λ°μ΄ν„° μ •ν•©μ„± κΉ¨μ§**

---


### β™οΈ Javaμ—μ„ μ‚¬μ©ν•  μ μλ” λ™μ‹μ„± μ μ–΄ λ°©μ‹

#### λ³Έ κ³Όμ μ—μ„λ” λ¶„μ‚°ν™κ²½μ„ κ³ λ ¤ν•μ§€ μ•μΌλ©°, Mapμ„ ν™μ©ν• μΈλ©”λ¨λ¦¬ DB λ°©μ‹μ„ μ‚¬μ©ν•©λ‹λ‹¤. λ”°λΌμ„ μ• ν”λ¦¬μΌ€μ΄μ… λ λ²¨μ—μ„ λ™μ‹μ„± μ μ–΄λ¥Ό ν•λ” λ°©λ²•μ„ ν•™μµν•©λ‹λ‹¤.

#### 1. synchronized
- λ©”μ„λ“λ‚ λΈ”λ΅μ— λ½μ„ κ±Έμ–΄ ν• λ²μ— ν•λ‚μ μ¤λ λ“λ§ μ ‘κ·Όν•λ„λ΅ λ³΄μ¥
- μλ°”μ λ¨λ“  κ°μ²΄λ” λ¨λ‹ν„° λ½μ„ κ°€μ§€κ³  μκ³ , synchronized ν‚¤μ›λ“λ¥Ό ν†µν•΄ μ•”λ¬µμ μΌλ΅ μ‚¬μ©
- νΉμ • κ°μ²΄μ λ¨λ‹ν„°λ½μ„ νλ“ν• μ¤λ λ“λ§ synchronized λ©”μ„λ“λ‚ λΈ”λ΅μ„ μ‹¤ν–‰ κ°€λ¥
- λ‹¤λ¥Έ μ¤λ λ“λ” λ¨λ‹ν„° λ½μ΄ ν•΄μ λ  λ•κΉμ§€ λ€κΈ°
- μ¤λ λ“μ μμ„λ¥Ό λ³΄μ¥ν•  μ μ—†μ

* **μ¥μ **: κ°„λ‹¨ν•κ² λ™μ‹μ„± μ μ–΄ κ°€λ¥, λΉ λ¥Έ κµ¬ν„ κ°€λ¥
* **λ‹¨μ **:
1)λ©”μ„λ“ μ „μ²΄κ°€ λ½μ— κ±Έλ¦¬λ―€λ΅ μ„±λ¥ μ €ν• κ°€λ¥μ„± μμ, λλ ¤μ§ μ μμ  2)μ„Έλ¶€ μ μ–΄ λ¶κ°€λ¥ (νƒ€μ„μ•„μ›ƒ, λ½ κ³µμ •μ„± λ“±)

#### 2. ReentrantLock
- lock(), unlock()μ„ λ…μ‹μ μΌλ΅ νΈμ¶ν•λ©° λ½μ„ νλ“/ν•΄μ ν•λ©° λ™μ‹μ„± μ μ–΄λ¥Ό ν•κΈ° λ•λ¬Έμ— ν΄λ¨Όμ—λ¬ λ°μƒ κ°€λ¥
- κΈ°λ³Έμ μΌλ΅ μ¤λ λ“κ°€ λ™μ‹ μ”μ²­ν–μ„ λ• μμ„λ¥Ό λ³΄μ¥λμ§€ μ•μ§€λ§, κ³µμ •λ½(fairness) λ¨λ“λ΅ μ„¤μ •ν•λ©΄ λ€κΈ° μ¤‘μΈ μ¤λ λ“μ—κ² μμ°¨μ μΌλ΅ λ½μ΄ ν• λ‹Ή λ¨
- κ³µμ • λ¨λ“λ” λ½ λ‚΄λ¶€μ—μ„ νλ¥Ό μ‚¬μ©ν•μ—¬ λ€κΈ° μ¤‘μΈ μ¤λ λ“μ μμ„λ¥Ό λ³΄μ¥

* **μ¥μ **: 1) νƒ€μ„μ•„μ›ƒ, κ³µμ •μ„±, μΈν„°λ½νΈ μ²λ¦¬ κ°€λ¥ 2) ν•„μ”ν• λ²”μ„λ§ λ½ κ°€λ¥ (λ©”μ„λ“ μ „μ²΄ X)
* **λ‹¨μ **: lock()/unlock() λ„λ½ μ„ν—, μ½”λ“ λ³µμ΅λ„ β†‘

#### 3. AtomicInteger, AtomicLong λ“± CAS κΈ°λ° μ›μ μ—°μ‚°
- μ—°μ‚°μ—μ„ κΈ°λ€ν•λ” κ°’κ³Ό μ €μ¥λ κ°’μ„ λΉ„κµν•΄μ„ λ‘κ°κ°€ μΌμΉν•  λ•λ§ κ°’μ„ μμ •
- λ½μ„ μ‚¬μ©ν•μ§€ μ•μ•„ λ½ κ²½ν•©μ΄ μΌμ–΄λ‚μ§€ μ•μ

* **μ¥μ **: μ„±λ¥ λ›°μ–΄λ‚¨, κ²½λ‰ λ½ λ€μ²΄ κ°€λ¥
* **λ‹¨μ **: λ³µμ΅ν• μ—°μ‚°μ€ μ²λ¦¬ λ¶κ°€

---

### π§ λ³Έ κ³Όμ μ—μ„ μ μ©ν• λ°©μ‹

#### β… `synchronized`
#### λ™μ‹μ„±μ„ ν—μ©ν•λ©΄μ„ λ™μ‹μ„±μ„ μ μ–΄ν–μµλ‹λ‹¤. μλ¥Όλ“¤μ–΄ Aμ μ¶©μ „κ³Ό μ‚¬μ©μ΄ λ™μ‹ μ”μ²­ λμ—μ„ λ• κ° μ”μ²­μ΄ μμ°¨μ μΌλ΅ μ‹¤ν–‰λ©λ‹λ‹¤.

```java
// ν¬μΈνΈ μ‚¬μ©
public synchronized UserPoint chargePoint(long userId, long chargeAmount) {
        if (chargeAmount <= 0) throw new IllegalArgumentException("μ¶©μ „ κΈμ•΅μ€ 1μ› μ΄μƒμ΄μ–΄μ•Ό ν•©λ‹λ‹¤.");
        
        UserPoint currentPoint = userPointTable.selectById(userId);
        long updatePoint = currentPoint.point() + chargeAmount;

        if (MAX_POINT < updatePoint) throw new IllegalArgumentException(String.format("μµλ€ ν¬μΈνΈ ν•λ„(%d)λ¥Ό μ΄κ³Όν•  μ μ—†μµλ‹λ‹¤.", MAX_POINT));
        
        pointHistoryTable.insert(userId, chargeAmount, TransactionType.CHARGE, System.currentTimeMillis());

        return userPointTable.insertOrUpdate(userId, updatePoint);
    }

// ν¬μΈνΈ μ¶©μ „
public synchronized UserPoint usePoint(long userId, long useRequestAmount) {
        if (useRequestAmount <= 0) throw new IllegalArgumentException("μ‚¬μ© κΈμ•΅μ€ 1μ› μ΄μƒμ΄μ–΄μ•Ό ν•©λ‹λ‹¤.");
        
        UserPoint currentPoint = userPointTable.selectById(userId);
        long updatePoint = currentPoint.point() - useRequestAmount;

        if (updatePoint < 0) throw new IllegalArgumentException(String.format("ν¬μΈνΈκ°€ λ¶€μ΅±ν•©λ‹λ‹¤. ν„μ¬ ν¬μΈνΈ: %d, μ‚¬μ© μ”μ²­ κΈμ•΅: %d", currentPoint.point(), useRequestAmount));
        
        pointHistoryTable.insert(userId, useRequestAmount, TransactionType.USE, System.currentTimeMillis());

        return userPointTable.insertOrUpdate(userId, updatePoint);
    }
```

- **PointService** ν΄λμ¤μ `chargePoint()` λ° `usePoint()` λ©”μ„λ“μ— `synchronized` ν‚¤μ›λ“λ¥Ό μ μ©
- **ν• μ μ €μ ν¬μΈνΈ μ ‘κ·Όμ΄ ν• λ²μ— ν•λ‚μ μ¤λ λ“λ§ κ°€λ¥ν•λ„λ΅ μ μ–΄**



**π¨ λ¬Έμ μ **
* λ©”μ„λ“ μ „μ²΄κ°€ λ½μ— κ±Έλ¦¬λ―€λ΅ λ‹¤λ¥Έ μ μ €μ μ”μ²­μ—λ„ λ™μ‹μ„±μ— μ μ–΄λλ” λ“± λ¶ν•„μ”ν• λ€κΈ° λ°μƒ (μ„±λ¥μ €ν•)
* μ‘μ—…μ μμ„ λ³΄μ¥X

---

### π› οΈ ν–¥ν›„ κ°μ„  κ³ λ ¤: `ReentrantLock`

#### λ³Έ κ³Όμ μ—μ„λ” μ‹κ°„μƒμ μ΄μ λ΅ `ReentrantLock` λ°©μ‹μΌλ΅ κµ¬ν„μ€ μ§„ν–‰ν•μ§€ λ»ν–μµλ‹λ‹¤. μ¶”ν›„ κ°μ„  μ‹ ν•΄λ‹Ή λ°©μ‹μΌλ΅ λ¦¬ν©ν† λ§ ν•  μμ •μ…λ‹λ‹¤.

- μ‚¬μ©μλ³„λ΅ λ³„λ„μ λ½μ„ κ±Έ μ μλ„λ΅ `ConcurrentHashMap<Long, ReentrantLock>` μ‚¬μ©
- μ¶©μ „/μ‚¬μ© μ”μ²­μ— λ€ν•΄ λ” μ„Έλ°€ν• λ½ μ μ–΄ κ°€λ¥


---

### π’΅ λ™μ‹μ„± ν…μ¤νΈ μ „λµ

- λ³Έ κ³Όμ μ—μ„λ”  `ExecutorService + CountDownLatch` μ΅°ν•©μ„ μ‚¬μ©ν•μ—¬ **2κ°μ μ”μ²­μ„ λ™μ‹μ— λ°μƒμ‹ν‚¤κ³  μ²λ¦¬ κ²°κ³Όλ¥Ό ν™•μΈν•λ” λ°©μ‹**μΌλ΅ ν…μ¤νΈλ¥Ό κµ¬ν„ν–μµλ‹λ‹¤.
-  ν…μ¤νΈ μΌ€μ΄μ¤: 1) λ™μΌ μ μ €μ 2κ°μ λ™μ‹ μ¶©μ „ μ”μ²­ 2) λ™μΌ μ μ €μ 2κ°μ λ™μ‹ μ‚¬μ© μ”μ²­ 3) λ™μΌ μ μ €μ μ¶©μ „ + μ‚¬μ© λ™μ‹ μ”μ²­

### π“ λΉ„κµ) `CompletableFuture` vs `ExecutorService + CountDownLatch`

#### Javaμ—μ„ λΉ„λ™κΈ° μ‘μ—…μ„ μ²λ¦¬ν•κ±°λ‚ λ™μ‹μ„± ν…μ¤νΈ/μ μ–΄λ¥Ό κµ¬ν„ν•  λ• λ§μ΄ μ‚¬μ©λλ” λ‘ κ°€μ§€ λ°©μ‹μΈ `CompletableFuture`μ™€ `ExecutorService + CountDownLatch`λ¥Ό λΉ„κµν•©λ‹λ‹¤.

| ν•­λ© | `CompletableFuture` | `ExecutorService + CountDownLatch` |
|------|----------------------|-------------------------------------|
| μ‚¬μ© λ©μ  | λΉ„λ™κΈ° μ‘μ—… μ²λ¦¬, μ½λ°± μ—°κ²° | λ³‘λ ¬ μ‘μ—… μ‹¤ν–‰ ν›„ λ™κΈ°ν™” (λ€κΈ°) |
| μ½”λ“ μ¤νƒ€μΌ | ν•¨μν•, μ„ μ–Έν• μ¤νƒ€μΌ (μ²΄μ΄λ‹) | λ…λ Ήν• μ¤νƒ€μΌ, μ§μ ‘ μ¤λ λ“ μ μ–΄ |
| μμ™Έ μ²λ¦¬ | `handle()`, `exceptionally()` λ“± μ²΄μ΄λ‹μΌλ΅ μ²λ¦¬ κ°€λ¥ | `try-catch` μ‚¬μ© |
| μ¤λ λ“ ν’€ | λ‚΄λ¶€μ μΌλ΅ `ForkJoinPool` μ‚¬μ© (`supplyAsync()` λ“±) | λ…μ‹μ μΌλ΅ `ExecutorService` μƒμ„± ν•„μ” |
| λ™μ‹ μ‘μ—… λ€κΈ° | `allOf()`, `join()` λ“±μ„ ν™μ©ν• μμ—°μ¤λ¬μ΄ λ€κΈ° | `CountDownLatch.await()` λ…μ‹μ  λ€κΈ° |
| κ°€λ…μ„± | κ°„κ²°ν•κ³  μ²΄μ΄λ‹μΌλ΅ κΉ”λ” | μµμ™ν•μ§€λ§ κµ¬μ΅°κ°€ κΈΈμ–΄μ§ μ μμ |
| ν…μ¤νΈ μ©μ΄μ„± | ν…μ¤νΈ μ½”λ“μ—μ„  νλ¦„ νμ•… μ–΄λ ¤μΈ μ μμ | ν…μ¤νΈ νλ¦„μ„ λ…μ‹μ μΌλ΅ μ μ–΄ κ°€λ¥ |
| μ ν•©ν• μƒν™© | λΉ„λ™κΈ° μ½λ°±, μ²΄μ΄λ‹λ μ‘μ—… μ²λ¦¬ | ν…μ¤νΈ μ½”λ“, λ‹¨μ λ³‘λ ¬ μ‘μ—… μ‹¤ν–‰ ν›„ ν™•μΈ |

---

### β¨ κ²°λ΅ 

- **λ‹¨μΌ μ„λ²„ κΈ°λ°**μΈ μ΄λ² κ³Όμ μ—μ„λ” `synchronized` λ§μΌλ΅λ„ μ¶©λ¶„ν μ•μ •μ μΈ λ™μ‹μ„± μ μ–΄κ°€ κ°€λ¥
- **κ·Έλ¬λ‚ `ReentrantLock`** λ“± λ” μ •λ°€ν• μ μ–΄ λ°©μ‹μΌλ΅ κ°μ„  ν•„μ”
